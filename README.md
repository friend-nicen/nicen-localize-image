```
/**
Plugin Name: nicen-localize-image
Plugin URI:https://nicen.cn/2893.html
Description: 用于本地化文章的外部图片的插件，支持文章发布前通过编辑器插件本地化、文章发布时自动本地化、定时发布文章时自动本地化、已发布的文章批量本地化。
Version: 2.1.0
Author: 友人a丶
Author URI: https://nicen.cn
Text Domain: nicen-localize-image
License: GPLv2 or later
 */
```

# 插件介绍

nicen-localize-image，是一款用于本地化文章的外部图片的插件，支持如下功能：

1. 文章发布前通过编辑器插件本地化
2. 文章手动发布时自动本地化
3. 文章定时发布时自动本地化
4. 针对已发布的文章批量本地化。

# Pro版介绍

39.9无加密、无授权、无域名限制、持续更新，请加微信good7341，购买后会邀请您加入Pro用户群：

1. 支持图片本地化后按照年月日存放在指定的本地化图片保存目录
2. 支持编辑器内可直接复制粘贴软件截图和本地图片，并自动上传到服务器
3. 支持文章发布时自动给a标签添加target="_blank"属性
4. 支持本地化图片时可自定义referer，绕过防盗链
5. 支持本地化图片后自动添加设置的水印，自带超完备的图片水印功能
6. 支持本地化时直接上传对象存储，并替换链接为对象存储的链接
7. 支持图片水印、对象存储、定时任务等功能，共同协作
8. 支持批量本地化并发进行，可同时处理N篇文章的图片本地化
9. 支持本地化后保存为webp格式
10. 支持设置代理IP，绕过IP防火墙
11. 支持媒体库上传图片时，添加水印，转存对象存储

# 更新日志：

<font color="red">开源版已进入维护阶段，v1.4.1以后只修复BUG不再更新新功能，新功能将发布在Pro版（Pro版）</font>

## 2.1.0

1. 新增对象存储支持七牛云
2. 新增对象存储可选按年月日保存文件
3. 新增对象存储可选是否处理媒体库上传的文件

## 2.0.12

1. 新增支持绕过某些特殊的防盗链
2. 新增可设置本地化后清空IMG标签除src之外的其它属性

## 2.0.11

1. 修复webp转换导致运行异常的BUG

## 2.0.10

1. 修复开启webp转换后原图不会删除的BUG。
2. 新增特色图片可以设置使用第一张图

## 2.0.9

1. 新增开启webp转换后，可以设置指定类型的图片不进行webp转换
2. 新增开启图片水印后，可以设置指定类型的图片不添加水印

## 2.0.8

1. 修复指定百分比时透明水印变黑
2. 修复开启保存到数据库会导致水印重复添加

## 2.0.7

1. 修复水印功能使用图片水印丢失透明度的问题

## 2.0.6

1. 修复定时任务日志显示异常的问题
2. 修复某些情况下产生异常报错的情况

## 2.0.5

1. 重构定时任务，发布时将不依赖于wp的定时任务。
2. 定时任务支持设置时间范围，自动随机生成下一次发布时间。

## 2.0.4

1. 支持媒体库上传时，添加水印和上传对象存储
2. 新增媒体库可以直接选取对象存储的图片

## 2.0.3

1. 修复启用webp转换功能后，无法正常添加水印的问题。

## 2.0.3

1. 新增图片可保存为webp文件
2. 新增水印可自定义图片水印的百分比大小

## 2.0.1

1. 新增自定义网络请求代理

## 2.0.0

1. 新增本地化后，图片上传到对象存储（阿里云、腾讯云）
2. 新增定时任务可选单次定时发布的文章数量和状态
3. 新增编辑器插件本地化可以并发下载（默认同时下载5张图片）
4. 新增批量本地化并发下载，可单独设置需要同时本地化的文章数量
5. 新增本地化图片保存到数据库时，可选是否生成缩略图
6. 新增本地化图片添加域名时，可指定需要添加的域名
7. 新增批量本地化时，可选待审、定时任务等其它文章状态
8. 新增字体库列表，移除水印功能自带字体文件，在水印功能页点击下载字体自行下载
9. 新增水印功能可设置过滤规则，对于长宽小于指定值的图片不添加水印
10. 新增删除文章时可选是否自动删除文章关联的图片附件
11. 修复编辑器插件本地化时，图片数量小于并发数时，会导致本地化链接不会替换的问题
12. 修复图片水印模式下，字体文件不存在时，会导致报错的问题
13. 修复图片粘贴自动本地化上传时，特殊情形下会出现报错的问题
14. 修复存在空格时，会导致白名单功能失效的问题

## 1.4.1

1. 修复编辑器插件存在相同图片链接时，只会替换一次的问题
2. 修复复制网页图片时，触发粘贴图片上传，会导致重复上传生成两张图片的问题
3. 修复本地化图片验证图片链接状态码，没有模拟Referer导致触发防盗链，刚好链接返回异常状态码时，会本地化报错的问题。
4. 新增本地化时是否记录日志的选项，关闭后将不在记录日志。
5. 修复定时任务发布时，修改文章时间发布时间为定时任务触发时间，不生效的问题。
6. 增加文章定时发布任务有效性检测，防止被其它插件删除定时任务后，定时发布无法正常运行的问题

## 1.4.0

1. 修复分类名包含特殊字符时，批量本地化时，分类无法正常显示的问题
2. 新增系统时间校准的功能开关，定时任务页面将展示当前系统时间和默认时区，避免由时区导致定时任务无法正常运行
3. 新增图片本地化后自动关联文章
4. 新增图片本地化后按照年月日存放在指定的本地化图片保存目录
5. 更新img匹配规则，兼容一些不规则的img标签
6. 修复开启图片本地化时保存到数据库功能后，本地化报错的问题
7. 新增编辑器内可直接粘贴截图，并自动上传到服务器
8. 新增自定义referer，绕过图片防盗链

## 1.3.83

1. 修复其他主题或插件全局加载Vue时会导致插件后台无法正常加载的问题（内置js文件，插件大小会增加2M）
2. 将指定文件类型修改为图片本地化时自动检测文件类型；
3. 修复本地化保存到数据库文件显示异常的问题；
4. 新增可设置图片本地化后，自动将图片设置为文章的特色图片；
5. 新增自动给图片添加alt属性时，会将空值的alt重新设置；
6. 修复图片压缩时会重复下载两次的问题；
7. 文章发布时自动本地化后不再进行弹出提醒，处理结果会跟随wordpress默认提示进行输出；

## 1.3.82

1. 移除插件内的时区定义代码（导致某些情况下文章发布时间出现偏差）；

## 1.3.81

1. 修复wordpress不使用默认表前缀安装时，批量本地化无法检测的问题；
2. 修复批量本地化时，清空时间范围后无法检测的问题；

## v1.3.8

1. 修复设置界面，日期选择时异常报错导致无法清除的问题。

## v1.3.7

1. 新增定时任务可以指定日期范围、每日的时间范围进行定时发布。
2. 新增批量本地化时可选文章状态，可指定不限、草稿、已发布等文章状态进行批量本地化。
3. 优化批量压缩图片功能。

## v1.3.6

1. 修复edit_themes权限导致部分情况下无法显示配置页面的问题：edit_themes -> manage_options

## v1.3.5

1. 修复插件日志无法清空的问题
2. 更新图片压缩页面加载目录时异步加载，避免文件数量太多导致卡死；

## v1.3.4

1. 修复不规范的img标签，不会被匹配到的问题。

## v1.3.3

1. 修改代码适配wordpress插件商店规范；
2. 图片压缩完成后自动刷新显示的目录；
3. 修改网络请求超时时间为120s；

## v1.3.1 beta

1. 新增批量本地化时，可以指定文章分类，指定文章发布时间范围；
2. 新增域名白名单，插件将忽略白名单内的域名，不会进行本地化；
3. 新增自定义图片保存类型功能
4. 新增图片批量压缩功能；
5. 接口增加随机时间戳；
6. 优化自动发布文章的定时任务
7. 修复压缩图片时图片读取失败的问题
8. 修改代码适配wordpress插件商店规范

## v1.2.0 beta

1. 增加图片本地化日志收集的功能，随时了解本地化失败的原因；
2. 新增定时发布文章的功能，可设置定时发布时是否本地化文章图片；
3. 新增批量本地化已发布文章内外部图片的功能；
4. 新增插件更新日志，便于用户及时响应插件更新；
5. 新增插件BUG在线反馈的功能，便于及时修复问题；
6. 修改接口密钥为安装插件后随机生成，防止接口被恶意利用；
7. 新增图片本地化时是否添加网站域名的功能开关，开启后本地化后的图片链接为包含域名的完整路径；

## v1.1.3

1. 本地化下载图片的方式调整为curl获取，并模拟referer绕过防盗链；
2. 修改插件全局变量、函数的命名前缀；
3. 修复没有判断图片下载结果导致的异常问题；

# 仓库地址

Github：[https://github.com/friend-nicen/nicen-localize-image](https://github.com/friend-nicen/nicen-localize-image)

Gitee：[https://gitee.com/friend-nicen/nicen-localize-image](https://gitee.com/friend-nicen/nicen-localize-image)

# 功能说明

插件提供两种本地化外部图片的模式，两种模式可同时开启，互不冲突；
![alt 属性文本](https://nicen.cn/wp-content/uploads/2022/08/1661002814846.png)

## 编辑器本地化插件

启用这个模式之后，会将wordpress文章编辑器切换为经典编辑器，并在编辑器上方新增一个功能图标，点击之后可以自动检测并本地化所有外部图片；

![alt 属性文本](https://nicen.cn/wp-content/uploads/2022/08/1661008460684.png)
![alt 属性文本](https://nicen.cn/wp-content/uploads/2022/08/1661008539461.png)

## 发布时自动本地化

启用这个模式之后会在文章发布时自动本地化所有外部图片；
![alt 属性文本](https://nicen.cn/wp-content/uploads/2022/08/1661008642570.png)

推荐使用【编辑器本地化插件】在发布前进行本地化，当图片数量过多或者文件太大【发布时自动本地化】可能会导致请求卡死。